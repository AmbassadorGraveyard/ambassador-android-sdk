machine:

  java:
    version: 'oraclejdk8'

  timezone:
    America/New_York # Set the timezone
  
  environment:    
    RAINFOREST_TOKEN: $RAINFOREST_TOKEN
    RAINFOREST_SITE: 5193

dependencies:
 pre:
    - curl -sL https://github.com/jpm4j/jpm4j.installers/raw/master/dist/biz.aQute.jpm.run.jar >jpm4j.jar
    - sudo java -jar jpm4j.jar -g init
    - sudo apt-get install jq
    - wget -O ~/codacy-coverage-reporter-assembly-latest.jar $(curl https://api.github.com/repos/codacy/codacy-coverage-reporter/releases/latest | jq -r .assets[0].browser_download_url)
    - sudo pip install awscli
    - curl -O https://bin.equinox.io/c/htRtQZagtfg/rainforest-cli-stable-linux-amd64.tgz
    - sudo tar -xf rainforest-cli-stable-linux-amd64.tgz -C /usr/local/bin
    - bash secrets.sh

test:
  override:
    - ./gradlew -p ambassadorsdk jacocoReport
    - cp -r ambassadorsdk/build/reports/jacoco/jacocoReport/* $CIRCLE_TEST_REPORTS
    - cp -r ambassadorsdk/build/reports/tests/debug/* $CIRCLE_TEST_REPORTS
    - ./gradlew -p ambassadorsdk-demo assembleDebug --quiet;
    - ./rainforest.sh

  post:
    - java -jar ~/codacy-coverage-reporter-assembly-latest.jar report -l Java -r $CIRCLE_TEST_REPORTS/jacocoReport.xml

